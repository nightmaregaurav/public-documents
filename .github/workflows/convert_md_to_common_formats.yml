name: Convert Markdown to TEX, PDF, DOCX, TXT

on:
  push:
    paths:
      - "**/*.md"
      - "!**/README.md"
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Prepare git config
        run: git config --global user.email "nightmaregaurav@users.noreply.github.com" && git config --global user.name "Gaurav Nyaupane"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-recommended \
            texlive-latex-extra

      - name: Convert Markdown files
        run: |
          shopt -s globstar
          for file in **/*.md; do
            if [[ "$(basename "$file")" != "README.md" ]]; then
              base="${file%.md}"
              # Convert to TEX
              pandoc "$file" -o "${base}.tex" -V papersize:a4 -V geometry:top=2cm,left=2.5cm,right=2.5cm,bottom=2cm
              # Convert to PDF
              pandoc "$file" -o "${base}.pdf" --pdf-engine=xelatex -V papersize:a4 -V geometry:top=2cm,left=2.5cm,right=2.5cm,bottom=2cm
              # Convert to DOCX
              pandoc "$file" -o "${base}.docx"
              # Convert to plain TXT
              pandoc "$file" -t plain -o "${base}.txt"
            fi
          done

      - name: Commit and push generated files
        run: |
          find . -type f \( -name "*.pdf" -o -name "*.docx" -o -name "*.txt" -o -name "*.tex" \) -exec git add {} +
          git diff --cached --quiet || git commit -m "Auto-generate TEX, PDF, DOCX, TXT from Markdown"
          git push
